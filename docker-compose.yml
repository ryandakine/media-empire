version: '3.8'

services:
  # Jellyfin Media Server
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    networks:
      - media-empire
    ports:
      - "8096:8096" # Web UI (will be proxied later)
      - "8920:8920" # HTTPS (will be proxied later)
    volumes:
      - jellyfin_config:/config
      - /media/ryan/ROOTFS/media_empire/movies:/media/movies:ro
      - /media/ryan/ROOTFS/media_empire/tv:/media/tv:ro
      - ./media/config/jellyfin:/config:rw
    environment:
      - TZ=${TZ:-America/New_York}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - JELLYFIN_PublishedServerUrl=http://jellyfin:8096
    # Hardware acceleration (uncomment based on your hardware)
    # For Intel QuickSync:
    # devices:
    #   - /dev/dri:/dev/dri
    # For NVIDIA:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8096/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # qBittorrent Download Client
  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
    volumes:
      - ./config/sabnzbd:/config
      - /media/ryan/ROOTFS/media_empire/downloads/sabnzbd:/downloads/sabnzbd
      - /media/ryan/ROOTFS/media_empire/usenet:/downloads/complete
    ports:
      - 8085:8080
    restart: unless-stopped
    networks:
      - media-empire

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    networks:
      - media-empire
    ports:
      - "8080:8080" # Web UI
    volumes:
      - qbittorrent_config:/config
      - /media/ryan/ROOTFS/media_empire/downloads:/downloads:rw
      - ./media/config/qbittorrent:/config:rw
    environment:
      - TZ=${TZ:-America/New_York}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - WEBUI_PORT=8080
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
    restart: unless-stopped

  # RDT-Client
  rdtclient:
    image: rogerfar/rdtclient:latest
    container_name: rdtclient
    networks:
      - media-empire
    ports:
      - "6500:6500"
    volumes:
      - ./media/config/rdtclient:/data/db:rw
      - /media/ryan/ROOTFS/media_empire/downloads:/data/downloads:rw
    environment:
      - TZ=${TZ:-America/New_York}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    restart: unless-stopped

  # Prowlarr Indexer Manager
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    networks:
      - media-empire
    ports:
      - "9696:9696" # Web UI
    volumes:
      - prowlarr_config:/config
      - ./media/config/prowlarr:/config:rw
    environment:
      - TZ=${TZ:-America/New_York}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped

  # Radarr Movie Manager
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    networks:
      - media-empire
    ports:
      - "7878:7878" # Web UI
    volumes:
      - radarr_config:/config
      - /media/ryan/ROOTFS/media_empire/movies:/movies:rw
      - /media/ryan/ROOTFS/media_empire/downloads:/downloads:rw
      - ./media/config/radarr:/config:rw
    environment:
      - TZ=${TZ:-America/New_York}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped

  # Sonarr TV Show Manager
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    networks:
      - media-empire
    ports:
      - "8989:8989" # Web UI
    volumes:
      - sonarr_config:/config
      - /media/ryan/ROOTFS/media_empire/tv:/tv:rw
      - /media/ryan/ROOTFS/media_empire/downloads:/downloads:rw
      - ./media/config/sonarr:/config:rw
    environment:
      - TZ=${TZ:-America/New_York}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped

  # Jackett Fallback Indexer
  jackett:
    image: lscr.io/linuxserver/jackett:latest
    container_name: jackett
    networks:
      - media-empire
    ports:
      - "9117:9117" # Web UI
    volumes:
      - jackett_config:/config
      - ./media/config/jackett:/config:rw
    environment:
      - TZ=${TZ:-America/New_York}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped

  # Bazarr Subtitle Manager
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    networks:
      - media-empire
    ports:
      - "6767:6767" # Web UI
    volumes:
      - bazarr_config:/config
      - ./media/movies:/movies:ro
      - ./media/tv:/tv:ro
      - ./media/config/bazarr:/config:rw
    environment:
      - TZ=${TZ:-America/New_York}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped

  # Tautulli Analytics
  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    networks:
      - media-empire
    ports:
      - "8181:8181" # Web UI
    volumes:
      - tautulli_config:/config
      - ./media/config/tautulli:/config:rw
    environment:
      - TZ=${TZ:-America/New_York}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped

  # Tdarr Transcoding
  tdarr:
    image: haveagitgat/tdarr:latest
    container_name: tdarr
    networks:
      - media-empire
    ports:
      - "8265:8265" # Web UI
      - "8266:8266" # Web UI (alternative)
    volumes:
      - tdarr_config:/config
      - ./media/movies:/media/movies:rw
      - ./media/tv:/media/tv:rw
      - ./media/config/tdarr:/config:rw
    environment:
      - TZ=${TZ:-America/New_York}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    # Hardware acceleration (same as Jellyfin)
    # devices:
    #   - /dev/dri:/dev/dri
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
    restart: unless-stopped

  # Jellyseerr Request Manager
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    networks:
      - media-empire
    ports:
      - "5055:5055"
    volumes:
      - ./media/config/jellyseerr:/app/config:rw
    environment:
      - LOG_LEVEL=debug
      - TZ=${TZ:-America/New_York}
    restart: unless-stopped

  # Unpackerr - RAR Extraction
  unpackerr:
    image: golift/unpackerr:latest
    container_name: unpackerr
    networks:
      - media-empire
    volumes:
      - ./media/downloads:/downloads:rw
    environment:
      - TZ=${TZ:-America/New_York}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - UN_SONARR_0_URL=http://172.17.0.1:8989
      - UN_SONARR_0_API_KEY=6c24a8cda3074638ad0c71e4e47d1e3b
      - UN_SONARR_0_PATHS_0=/downloads
      - UN_RADARR_0_URL=http://172.17.0.1:7878
      - UN_RADARR_0_API_KEY=c1f18a40ca024296b99de0836e82b85a
      - UN_RADARR_0_PATHS_0=/downloads
    restart: unless-stopped

  # Nginx Proxy Manager
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    networks:
      - media-empire
    ports:
      - "80:80"
      - "81:81"
      - "443:443"
    volumes:
      - ./media/config/nginx-proxy-manager/data:/data:rw
      - ./media/config/nginx-proxy-manager/letsencrypt:/etc/letsencrypt:rw
    restart: unless-stopped

  # Placeholder service to validate network configuration
  # Full services will be added in subsequent tasks
  network-test:
    image: alpine:latest
    command: sleep infinity
    networks:
      - media-empire
    volumes:
      # Bind mounts for media directories (will be used by all services)
      - ./media/config:/media/config:rw
      - ./media/downloads:/media/downloads:rw
      - ./media/movies:/media/movies:rw
      - ./media/tv:/media/tv:rw
      - ./media/parity:/media/parity:rw
    # Resource limits (example - will be customized per service)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped
    profiles:
      - test

networks:
  media-empire:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    name: media-empire

volumes:
  # Named volumes for service configurations
  jellyfin_config:
    driver: local
  radarr_config:
    driver: local
  sonarr_config:
    driver: local
  prowlarr_config:
    driver: local
  jackett_config:
    driver: local
  qbittorrent_config:
    driver: local

  bazarr_config:
    driver: local
  tautulli_config:
    driver: local
  tdarr_config:
    driver: local
  nginx_proxy_manager_data:
    driver: local
